#!/usr/bin/env sh
A=$1
B=$2

#echo "LOCAL: $A"
#echo "REMOTE: $B"
#echo "MERGED: $3" # unused

if [ -z "$USE_FENESTRO" ]; then
	USE_FENESTRO=false
fi
DELETE_TEMPFILES=true
DELAY_BEFORE_DELETING_TEMPFILES=0.3
BROWSER="" # "Firefox"
BASE_TEMP_FILE="/tmp/cleandifffapp"
TEMP_FILE="$(mktemp "$BASE_TEMP_FILE.XXXXXX").cdiff"
HTML_EXTENSION=".html"
# make sure we're only dealing with text files
unset LANG
# if you don't unset LANG then some files will cause the file command
# to return: ERROR: line 22: regexec error 17, (illegal byte sequence)

if file $A | grep 'text' >/dev/null 2>&1 || \
	file $B | grep 'text' >/dev/null 2>&1 ; then

	# The heart of our functionality.
	# diff the files and have dwdiff break the results down into smaller "words"

	# Because we _may_ be diffing HTML
	# We're using {{inserted}} {{deleted}} tags
	# instead of raw html ones
	# because we need to convert the < & > in any HTML
	# we are diffing to be &lt; & &gt;
	# Then we'll convert the {{ & }} to < & >

	dwdiff --start-delete="{{deleted}}" \
		--stop-delete="{{/deleted}}" \
		--start-insert="{{inserted}}" \
		--stop-insert="{{/inserted}}" \
	    --delimiters="\x0A%,;/:._{}[]()'\!|-=~><\"\\\\" \
		--repeat-markers \
		-A best --repeat-markers -L $A $B | cat > $TEMP_FILE

	# Extract the name of the file we're diffing
	# $A and $B aren't trustable as names because
	# when used with git diff(tool) they'll just be temp files.
	# There are a couple lines which start with --- and +++
	# which mention the name of the "left" and "right" sides of the diff.
	# I've chosen the "right" one because it's more likely to be
	# what you ended up with.
	#FILE_NAME=`grep -m1 --color=none +++ $TEMP_FILE | sed -e 's/+++ //' -e 's/	.*//'`
	FILE_NAME=`basename $1 | sed -E 's|^.{6}_||'`
	FILE_NAME_2=`basename $2 | sed -E 's|^.{6}_||'`
	if [ "$FILE_NAME" != "$FILE_NAME_2" ]; then
		if [ "$FILE_NAME" != "null" ] && [ "$FILE_NAME_2" != "null" ]; then
			FILE_NAME="$FILE_NAME -> $FILE_NAME_2"
		elif [ "$FILE_NAME" == "null" ]; then
			FILE_NAME=$FILE_NAME_2
		# otherwise FILE_NAME is good to go
		fi
	fi

	# Clean up the dwdiff output.
	# * Remove the escape codes that shouldn't be there but are
	#   1st 2 lines
	# * Remove the leading whitespace before the line numbers
	#   next line
	# * convert the content's < & > to &lt; & &gt;
	# * convert the double curlies around inserted and deleted to < & >
	# * give the newline only inserted & deleted tags some content
	#   a human can see
	# * add a css class to lines with no insertions or deletions

	cat $TEMP_FILE \
		| gsed -E "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})*)?[m,K,H,f,J]//gm" \
		| gsed -E "s/\x1B\([A-Z]{1}(\x1B\[[m,K,H,f,J])?//gm" \
	 	| sed -E "s/("$'\E'"\[([0-9]{1,3}((;[0-9]{1,3})*)?)?[m|K]) +([0-9]+)/\1\5/g" \
		| sed -e "s/</\&lt;/g" -e "s/>/\&gt;/g" \
		  -e "s/{{inserted}}/<inserted>/g" -e "s/{{\/inserted}}/<\/inserted>/g" \
		  -e "s/{{deleted}}/<deleted>/g" -e "s/{{\/deleted}}/<\/deleted>/g" \
		| sed -E 's/^ +([0-9]+:[0-9]+) *(.*)/<diffline><linum>\1<\/linum><raw>\2 <\/raw><\/diffline>/' \
	    | sed -e "s/<inserted><\/inserted>/<inserted>⏎<\/inserted>/g" \
		-e "s/<deleted><\/deleted>/<deleted>⏎<\/deleted>/g" \
		| sed -E "/inserted|deleted/!s/<diffline>/<diffline class='unchanged'>/g" \
		> $TEMP_FILE$HTML_EXTENSION


	# what's that you say?
	# symlinks suck in bash?
	# yes... yes they do.
	pushd `dirname $0` > /dev/null
	SCRIPT_PATH=`pwd -P`
	if [ -h "$SCRIPT_PATH/cdiff" ]; then # if it's a symbolic link
		SCRIPT_PATH=$(dirname $(readlink "$SCRIPT_PATH/cdiff" ))
		# set the path to the folder containing the file
		# the symlink points to
	fi
	# Haz ourselves some CSS
	# for prettification.
	CSS=$(cat "$SCRIPT_PATH/cleandiff.css")
	JS=$(cat "$SCRIPT_PATH/cleandiff.js")
	ICON=$(cat "$SCRIPT_PATH/visibility_icon.svg")

	# Haz ourselves some HTML
	# for browserfication.
	HEADER=$(cat <<EOL
	<html>
		<head>
			<title>$FILE_NAME</title>
			<style>
			$CSS
			</style>
			<script language="JavaScript">
				$JS
			</script>
		</head>
		<body>
			<input type="checkbox" id="unchanged_checkbox">
			<div class="filename">
				<label for="unchanged_checkbox">
            $ICON
			$FILE_NAME
				</label>
			</div>
			<diff>

EOL
		  )


	# Mas HTML por favor.
	FOOTER=$(cat <<EOL
			</diff>
		<script language="JavaScript">
            /* make the line numbers clickable
               and unhide some of the lines
               around the changes to provide context */
			activateLineNumbers();
		</script>
		</body>
	</html>

EOL
		  )


	# you put your header in, you put your css in, you put your footer in
	# and you shake it all around.
	echo "$HEADER$(<"$TEMP_FILE$HTML_EXTENSION")$FOOTER" > $TEMP_FILE$HTML_EXTENSION

	# You do the hokey pokey, and you turn yourself around.
	# That's what it's all about.

	if [ "$USE_FENESTRO" == "true" ]; then
		fenestra --path=$TEMP_FILE$HTML_EXTENSION --name="$FILE_NAME"
	elif [ "$BROWSER" != "" ]; then
		open -a "$BROWSER" $TEMP_FILE$HTML_EXTENSION
	else
		open $TEMP_FILE$HTML_EXTENSION
	fi
	sleep $DELAY_BEFORE_DELETING_TEMPFILES
	cp $TEMP_FILE$HTML_EXTENSION ~/Desktop/temp/$FILE_NAME$HTML_EXTENSION
    if [ "$DELETE_TEMPFILES" == "true" ]; then
		rm "$TEMP_FILE"*
    else
      echo "tempfiles for $FILE_NAME"
      echo "run rm $TEMP_FILE* to delete these."
      ls "$TEMP_FILE"*
    fi
	exit 0
else
	if [ "/dev/null" == "$A" ]; then
		echo "Skipping binary file $B" # an added file
	else
		echo "Skipping binary file $A" # a removed file
	fi
	exit 1 # we don't diff binary files
fi
